<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title th:text="${ad != null and ad.id != null ? 'Modifier annonce' : 'Nouvelle annonce'}">Annonce</title>

    <!-- Tailwind via CDN (si tu utilises déjà Tailwind autrement, supprime ceci) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSRF (Spring Security) : utile pour les POST AJAX de suppression -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
</head>

<body class="bg-gray-50">

<div class="max-w-5xl mx-auto px-4 md:px-6 py-8">
    <div class="bg-white/80 backdrop-blur rounded-2xl shadow-lg overflow-hidden">

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 md:p-8 text-white">
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight"
                th:text="${ad != null and ad.id != null ? 'Modifier annonce' : 'Nouvelle annonce'}">
                Nouvelle annonce
            </h1>
            <p class="opacity-90 mt-1 text-sm md:text-base"
               th:text="${ad != null and ad.id != null
             ? 'Modifie les détails de ton annonce et enregistre les changements.'
             : 'Décris ton article, ajoute des photos et publie en 1 clic.'}">
                Décris ton article, ajoute des photos et publie en 1 clic.
            </p>
        </div>

        <!-- Form (unique) -->
        <form th:action="${ad != null and ad.id != null} ? @{/ad/update/{id}(id=${ad.id})} : @{/ad/save}"
              th:object="${ad}"
              method="post"
              enctype="multipart/form-data"
              class="p-6 md:p-8 space-y-8">

            <!-- ID caché -->
            <input type="hidden" th:if="${ad != null and ad.id != null}" th:field="*{id}"/>

            <!-- Titre / Description -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Titre</span>
                    <input type="text" th:field="*{title}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block md:col-span-2">
                    <span class="font-semibold text-sm text-gray-700">Description</span>
                    <textarea th:field="*{description}" rows="4" required
                              class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                              placeholder="État, particularités, accessoires, raison de la vente…"></textarea>
                </label>
            </section>

            <!-- Prix / Catégorie -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Prix (CHF)</span>
                    <input type="number" step="0.01" min="0" th:field="*{price}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Catégorie</span>
                    <select th:field="*{category}" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">Choisir…</option>
                        <option value="car">Voitures</option>
                        <option value="electronics">Électronique</option>
                        <option value="home">Maison</option>
                        <option value="fashion">Mode</option>
                        <option value="sports">Sport</option>
                        <option value="toys">Jouets</option>
                        <option value="books">Livres</option>
                        <option value="music">Musique</option>
                        <option value="tools">Outils</option>
                        <option value="garden">Jardin</option>
                        <option value="pets">Animaux</option>
                        <option value="jobs">Emplois</option>
                        <option value="services">Services</option>
                        <option value="realestate">Immobilier</option>
                        <option value="collectibles">Collections</option>
                        <option value="other">Autre</option>
                    </select>
                </label>
            </section>

            <!-- Localisation -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Canton</span>
                    <select th:field="*{canton}" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">—</option>
                        <option value="AG">AG</option><option value="AI">AI</option><option value="AR">AR</option>
                        <option value="BE">BE</option><option value="BL">BL</option><option value="BS">BS</option>
                        <option value="FR">FR</option><option value="GE">GE</option><option value="GL">GL</option>
                        <option value="GR">GR</option><option value="JU">JU</option><option value="LU">LU</option>
                        <option value="NE">NE</option><option value="NW">NW</option><option value="OW">OW</option>
                        <option value="SG">SG</option><option value="SH">SH</option><option value="SO">SO</option>
                        <option value="SZ">SZ</option><option value="TG">TG</option><option value="TI">TI</option>
                        <option value="UR">UR</option><option value="VD">VD</option><option value="VS">VS</option>
                        <option value="ZG">ZG</option><option value="ZH">ZH</option>
                    </select>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Ville</span>
                    <input type="text" th:field="*{city}"
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>
            </section>

            <!-- Photos existantes (édition) -->
            <section th:if="${ad != null and ad.id != null}"
                     th:with="existingCount=${(images != null) ? #lists.size(images) : 0}"
                     class="space-y-3">

                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h2 class="text-lg font-semibold">Photos existantes</h2>
                    <p class="text-sm text-gray-600">
                        Total : <span class="font-semibold" id="existingCountText" th:text="${existingCount}">0</span> / 20
                    </p>
                </div>

                <div id="existingGrid"
                     class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"
                     th:if="${images != null and !#lists.isEmpty(images)}">

                    <div th:each="img, stat : ${images}"
                         class="relative group"
                         th:attr="data-idx=${stat.index}">
                        <img th:src="${img.url}"
                             th:alt="${img.alt}"
                             class="rounded-lg shadow-md w-full h-40 object-cover"/>

                        <!-- PAS DE FORM ICI : suppression en AJAX -->
                        <button type="button"
                                class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700 shadow"
                                th:attr="data-del-url=@{/ad/{adId}/image/{idx}/delete(adId=${ad.id}, idx=${stat.index})}"
                                onclick="deleteExistingImage(this)">
                            Supprimer
                        </button>
                    </div>
                </div>

                <div class="text-sm text-gray-500" th:if="${images == null or #lists.isEmpty(images)}">
                    Aucune photo existante.
                </div>
            </section>

            <!-- Upload nouvelles images -->
            <section class="space-y-3"
                     th:with="existingCount=${(images != null) ? #lists.size(images) : 0}">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <h2 class="text-lg font-semibold">Ajouter des photos</h2>
                    <p class="text-sm text-gray-700">
                        Il vous reste
                        <span id="remainingCount"
                              class="font-semibold"
                              th:text="${20 - existingCount}">20</span>
                        photo(s) à ajouter
                    </p>
                </div>

                <!-- Dropzone -->
                <div id="dropzone"
                     class="relative flex flex-col items-center justify-center
                    border-2 border-dashed border-gray-300
                    rounded-2xl p-8 text-center cursor-pointer
                    hover:border-blue-500 hover:bg-blue-50 transition"
                     th:attr="data-existing-count=${existingCount}">

                    <!-- INPUT FILE (Spring) -->
                    <input id="fileInput"
                           type="file"
                           name="files"
                           multiple
                           accept="image/*"
                           class="absolute inset-0 opacity-0 cursor-pointer"/>

                    <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16V4m10 12V4M3 20h18"/>
                    </svg>

                    <p class="text-sm text-gray-600">
                        <strong>Glissez-déposez</strong> vos images ici<br>
                        ou <span class="text-blue-600 underline">cliquez pour sélectionner</span>
                    </p>

                    <p class="mt-2 text-xs text-gray-500">
                        Maximum <span class="font-semibold">20</span> photos par annonce (existantes + nouvelles).
                    </p>
                </div>

                <!-- Message / Alerte -->
                <div id="uploadHint"
                     class="hidden text-sm rounded-lg border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2"></div>

                <!-- PREVIEW nouvelles images (sous la zone drag&drop) -->
                <div id="preview"
                     class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </section>

            <!-- Bouton -->
            <div class="pt-2">
                <button type="submit"
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-xl shadow transition"
                        th:text="${ad != null and ad.id != null ? 'Mettre à jour' : 'Publier l’annonce'}">
                    Publier l’annonce
                </button>
            </div>

        </form>
    </div>
</div>

<script>
    // ====== CONFIG ======
    const MAX_TOTAL = 20;

    // ====== CSRF (Spring Security) for AJAX POST ======
    function getCsrf() {
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || '';
        return { token, header };
    }

    // ====== DELETE EXISTING IMAGE (AJAX, no nested form) ======
    async function deleteExistingImage(btn) {
        if (!confirm("Supprimer cette photo ?")) return;

        const url = btn.dataset.delUrl;
        if (!url) return;

        const { token, header } = getCsrf();
        const headers = { 'X-Requested-With': 'XMLHttpRequest' };
        if (token && header) headers[header] = token;

        try {
            const res = await fetch(url, { method: 'POST', headers });
            if (!res.ok) throw new Error("Delete failed");

            // Remove card
            const card = btn.closest('[data-idx]');
            if (card) {
                card.style.transition = 'opacity .2s';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 200);
            }

            // Update counters (existingCount decreases => remaining increases)
            const dropzone = document.getElementById('dropzone');
            const existingCountText = document.getElementById('existingCountText');
            const remainingCountEl = document.getElementById('remainingCount');

            if (dropzone && remainingCountEl) {
                const currentExisting = parseInt(dropzone.dataset.existingCount || '0', 10);
                const newExisting = Math.max(0, currentExisting - 1);
                dropzone.dataset.existingCount = String(newExisting);

                if (existingCountText) existingCountText.textContent = String(newExisting);

                // remaining = MAX - existing - selectedNew
                const selectedNew = window.__selectedFiles ? window.__selectedFiles.length : 0;
                remainingCountEl.textContent = String(Math.max(0, MAX_TOTAL - newExisting - selectedNew));
            }

        } catch (e) {
            alert("Erreur lors de la suppression.");
            console.error(e);
        }
    }

    // ====== UPLOAD NEW IMAGES (preview + enforce max 20 total) ======
    (function initUploader() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const remainingCountEl = document.getElementById('remainingCount');
        const uploadHint = document.getElementById('uploadHint');

        if (!dropzone || !fileInput || !preview || !remainingCountEl || !uploadHint) return;

        let selectedFiles = []; // new images only
        window.__selectedFiles = selectedFiles;

        function existingCount() {
            return parseInt(dropzone.dataset.existingCount || '0', 10);
        }

        function setHint(msg) {
            if (!msg) {
                uploadHint.classList.add('hidden');
                uploadHint.textContent = '';
                return;
            }
            uploadHint.classList.remove('hidden');
            uploadHint.textContent = msg;
        }

        function updateRemainingUI() {
            const remain = Math.max(0, MAX_TOTAL - existingCount() - selectedFiles.length);
            remainingCountEl.textContent = String(remain);
        }

        function syncInputFiles() {
            // Important pour Spring: on remplace fileInput.files par la liste "selectedFiles"
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
            window.__selectedFiles = selectedFiles;
        }

        function renderPreview() {
            preview.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = e => {
                    const card = document.createElement('div');
                    card.className = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'rounded-lg shadow-md w-full h-40 object-cover';

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.innerHTML = '×';
                    delBtn.className =
                        'absolute top-1 right-1 bg-red-600 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-700 shadow';

                    delBtn.addEventListener('click', () => {
                        selectedFiles.splice(index, 1);
                        syncInputFiles();
                        updateRemainingUI();
                        renderPreview();
                        setHint('');
                    });

                    card.appendChild(img);
                    card.appendChild(delBtn);
                    preview.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        function addFiles(files) {
            const imgFiles = files.filter(f => f && f.type && f.type.startsWith('image/'));

            if (imgFiles.length === 0) {
                setHint("Aucun fichier image détecté.");
                return;
            }

            const free = MAX_TOTAL - existingCount() - selectedFiles.length;
            if (free <= 0) {
                setHint("Tu as déjà atteint la limite de 20 photos (existantes + nouvelles).");
                return;
            }

            let toAdd = imgFiles;
            if (imgFiles.length > free) {
                toAdd = imgFiles.slice(0, free);
                setHint(`Limite atteinte : seules ${free} photo(s) ont été ajoutées.`);
            } else {
                setHint('');
            }

            selectedFiles = selectedFiles.concat(toAdd);

            syncInputFiles();
            updateRemainingUI();
            renderPreview();
        }

        // Drag UI
        ['dragenter', 'dragover'].forEach(evt => {
            dropzone.addEventListener(evt, e => {
                e.preventDefault();
                dropzone.classList.add('border-blue-500', 'bg-blue-50');
            });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, e => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            });
        });

        // Drop files
        dropzone.addEventListener('drop', e => {
            const files = Array.from(e.dataTransfer.files || []);
            addFiles(files);
        });

        // Picker
        fileInput.addEventListener('change', () => {
            const files = Array.from(fileInput.files || []);
            addFiles(files);

            // reset pour permettre re-sélection des mêmes fichiers
            fileInput.value = '';
            syncInputFiles();
        });

        // Init UI
        updateRemainingUI();
    })();
</script>

</body>
</html>
