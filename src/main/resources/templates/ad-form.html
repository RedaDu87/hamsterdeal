<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="fr"
      th:replace="~{fragments/_layout :: base(~{::body})}">

<body class="bg-gray-50">

<div class="max-w-5xl mx-auto px-4 md:px-6 py-8">
    <div class="bg-white/80 backdrop-blur rounded-2xl shadow-lg overflow-hidden">

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 md:p-8 text-white">
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight"
                th:text="${ad.id == null ? 'Nouvelle annonce' : 'Modifier annonce'}">
                Nouvelle annonce
            </h1>
            <p class="opacity-90 mt-1 text-sm md:text-base"
               th:text="${ad.id == null ? 'Décris ton article, ajoute des photos et publie en 1 clic.' : 'Modifie les détails de ton annonce et enregistre les changements.'}">
                Décris ton article, ajoute des photos et publie en 1 clic.
            </p>
        </div>

        <!-- Formulaire -->

        <form th:if="${ad.id == null}"
              th:action="@{/ad/save}"
              th:object="${ad}"
              method="post" enctype="multipart/form-data"
              class="p-6 md:p-8 space-y-8">


            <!-- Titre / Description -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Titre</span>
                    <input type="text" th:field="*{title}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block md:col-span-2">
                    <span class="font-semibold text-sm text-gray-700">Description</span>
                    <textarea th:field="*{description}" rows="4" required
                              class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                              placeholder="État, particularités, accessoires, raison de la vente…"></textarea>
                </label>
            </section>

            <!-- Prix / Catégorie -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Prix (CHF)</span>
                    <input type="number" step="0.01" min="0" th:field="*{price}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Catégorie</span>
                    <select th:field="*{category}" id="categorySelect" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">Choisir…</option>
                        <option value="car">Voitures</option>
                        <option value="electronics">Électronique</option>
                        <option value="home">Maison</option>
                        <option value="fashion">Mode</option>
                        <option value="sports">Sport</option>
                        <option value="toys">Jouets</option>
                        <option value="books">Livres</option>
                        <option value="music">Musique</option>
                        <option value="tools">Outils</option>
                        <option value="garden">Jardin</option>
                        <option value="pets">Animaux</option>
                        <option value="jobs">Emplois</option>
                        <option value="services">Services</option>
                        <option value="realestate">Immobilier</option>
                        <option value="collectibles">Collections</option>
                        <option value="other">Autre</option>
                    </select>
                </label>
            </section>

            <!-- Localisation -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Canton</span>
                    <select th:field="*{canton}" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">—</option>
                        <option value="AG">AG</option><option value="AI">AI</option><option value="AR">AR</option>
                        <option value="BE">BE</option><option value="BL">BL</option><option value="BS">BS</option>
                        <option value="FR">FR</option><option value="GE">GE</option><option value="GL">GL</option>
                        <option value="GR">GR</option><option value="JU">JU</option><option value="LU">LU</option>
                        <option value="NE">NE</option><option value="NW">NW</option><option value="OW">OW</option>
                        <option value="SG">SG</option><option value="SH">SH</option><option value="SO">SO</option>
                        <option value="SZ">SZ</option><option value="TG">TG</option><option value="TI">TI</option>
                        <option value="UR">UR</option><option value="VD">VD</option><option value="VS">VS</option>
                        <option value="ZG">ZG</option><option value="ZH">ZH</option>
                    </select>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Ville</span>
                    <input type="text" th:field="*{city}"
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>
            </section>

            <!-- Photos existantes (mode édition) -->
            <section th:if="${ad.id != null}">
                <h2 class="text-lg font-semibold mb-2">Photos existantes</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <div th:each="img, stat : ${images}" class="relative group">
                        <img th:src="${img.url}" th:alt="${img.alt}"
                             class="rounded-lg shadow-md w-full h-40 object-cover"/>
                        <form th:action="@{/ad/{adId}/image/{idx}/delete(adId=${ad.id}, idx=${stat.index})}"
                              method="post"
                              class="absolute top-2 right-2">
                            <button type="submit"
                                    class="bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700">
                                Supprimer
                            </button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Upload images -->
            <!-- Zone drag & drop -->
            <section>
                <h2 class="text-lg font-semibold mb-2">Ajouter des photos</h2>

                <div id="dropArea"
                     class="flex flex-col items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                    <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16V4m0 0L3 8m4-4l4 4M21 12v6a2 2 0 01-2 2H7a2 2 0 01-2-2v-6" />
                    </svg>
                    <p class="text-sm text-gray-500">Glisse-dépose des fichiers ici ou clique pour parcourir</p>
                    <input id="fileInput" name="files" type="file" accept="image/*" multiple class="hidden"/>

                </div>

                <!-- Preview -->
                <div id="thumbGrid" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </section>

            <!-- Bouton -->
            <div class="pt-2">
                <button type="submit"
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-xl shadow transition"
                        th:text="'Publier l’annonce'">

                </button>
            </div>

        </form>

        <form th:unless="${ad.id == null}"
              th:action="@{/ad/update/{id}(id=${ad.id})}"
              th:object="${ad}"
              method="post"
              enctype="multipart/form-data"
              class="p-6 md:p-8 space-y-8">

            <!-- ID caché -->
            <input type="hidden" th:field="*{id}"/>

            <!-- Titre / Description -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Titre</span>
                    <input type="text" th:field="*{title}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300
                          focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block md:col-span-2">
                    <span class="font-semibold text-sm text-gray-700">Description</span>
                    <textarea th:field="*{description}" rows="4" required
                              class="mt-1 w-full p-3 rounded-lg border border-gray-300
                             focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                              placeholder="État, particularités, accessoires, raison de la vente…"></textarea>
                </label>
            </section>

            <!-- Prix / Catégorie -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Prix (CHF)</span>
                    <input type="number" step="0.01" min="0" th:field="*{price}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300
                          focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Catégorie</span>
                    <select th:field="*{category}" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white
                           focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">Choisir…</option>
                        <option value="car">Voitures</option>
                        <option value="electronics">Électronique</option>
                        <option value="home">Maison</option>
                        <option value="fashion">Mode</option>
                        <option value="sports">Sport</option>
                        <option value="other">Autre</option>
                    </select>
                </label>
            </section>

            <!-- Localisation -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Canton</span>
                    <select th:field="*{canton}" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white
                           focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="">—</option>
                        <option value="VD">VD</option>
                        <option value="GE">GE</option>
                        <option value="FR">FR</option>
                        <option value="NE">NE</option>
                        <option value="VS">VS</option>
                    </select>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700">Ville</span>
                    <input type="text" th:field="*{city}"
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300
                          focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>
            </section>

            <!-- Upload nouvelles images -->
            <section>
                <h2 class="text-lg font-semibold mb-2">Ajouter des photos</h2>

                <div id="dropzone"
                     class="relative flex flex-col items-center justify-center
                border-2 border-dashed border-gray-300
                rounded-2xl p-8 text-center cursor-pointer
                hover:border-blue-500 hover:bg-blue-50
                transition">

                    <!-- INPUT FILE (obligatoire pour Spring) -->
                    <input id="fileInput"
                           type="file"
                           name="files"
                           multiple
                           accept="image/*"
                           class="absolute inset-0 opacity-0 cursor-pointer"/>

                    <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16V4m10 12V4M3 20h18"/>
                    </svg>

                    <p class="text-sm text-gray-600">
                        <strong>Glissez-déposez</strong> vos images ici<br>
                        ou <span class="text-blue-600 underline">cliquez pour sélectionner</span>
                    </p>
                </div>

                <!-- PREVIEW -->
                <div id="preview"
                     class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </section>


            <!-- Bouton -->
            <div class="pt-2">
                <button type="submit"
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700
                       text-white font-semibold px-6 py-3 rounded-xl shadow transition">
                    Mettre à jour
                </button>
            </div>

        </form>
        <section th:if="${ad.id != null}" class="mt-8">
            <h2 class="text-lg font-semibold mb-2">Photos existantes</h2>

            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <div th:each="img, stat : ${images}" class="relative">
                    <img th:src="${img.url}"
                         th:alt="${img.alt}"
                         class="rounded-lg shadow-md w-full h-40 object-cover"/>

                    <!-- FORM INDÉPENDANT (OK) -->
                    <form th:action="@{/ad/{adId}/image/{idx}/delete(adId=${ad.id}, idx=${stat.index})}"
                          method="post"
                          class="absolute top-2 right-2">
                        <button type="submit"
                                class="bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700">
                            Supprimer
                        </button>
                    </form>
                </div>
            </div>
        </section>


    </div>
</div>
<script>
const dropArea = document.getElementById("dropArea");
const fileInput = document.getElementById("fileInput");
const thumbGrid = document.getElementById("thumbGrid");
let selectedFiles = []; // ✅ on garde les fichiers ajoutés dans un tableau JS

// Clique → ouvre le sélecteur
dropArea.addEventListener("click", () => fileInput.click());

// Drag & drop
["dragenter", "dragover"].forEach(event => {
  dropArea.addEventListener(event, e => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.add("bg-blue-50", "border-blue-400");
  });
});

["dragleave", "drop"].forEach(event => {
  dropArea.addEventListener(event, e => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.remove("bg-blue-50", "border-blue-400");
  });
});

dropArea.addEventListener("drop", e => {
  const files = Array.from(e.dataTransfer.files);
  addFiles(files);
});

fileInput.addEventListener("change", () => {
  const files = Array.from(fileInput.files);
  addFiles(files);
});

function addFiles(files) {
  // ⚠️ Limite de 10 fichiers max
  if (selectedFiles.length + files.length > 10) {
    alert("Tu peux ajouter au maximum 10 photos.");
    return;
  }

  selectedFiles = selectedFiles.concat(files);
  refreshPreview();

}

function refreshPreview() {
  thumbGrid.innerHTML = "";
  selectedFiles.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = e => {
      const div = document.createElement("div");
      div.className = "relative";

      const img = document.createElement("img");
      img.src = e.target.result;
      img.className = "rounded-lg shadow-md w-full h-40 object-cover";

      const delBtn = document.createElement("button");
      delBtn.innerHTML = "×";
      delBtn.className =
        "absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-700";
      delBtn.onclick = () => {
        selectedFiles.splice(index, 1);
        refreshPreview();
      };

      div.appendChild(img);
      div.appendChild(delBtn);
      thumbGrid.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}
</script>
<script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');

    if (dropzone && fileInput) {

        ['dragenter', 'dragover'].forEach(event => {
            dropzone.addEventListener(event, e => {
                e.preventDefault();
                dropzone.classList.add('border-blue-500', 'bg-blue-50');
            });
        });

        ['dragleave', 'drop'].forEach(event => {
            dropzone.addEventListener(event, e => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            });
        });

        dropzone.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            fileInput.files = files;
            renderPreview(files);
        });

        fileInput.addEventListener('change', () => {
            renderPreview(fileInput.files);
        });
    }

    function renderPreview(files) {
        preview.innerHTML = '';
        Array.from(files).forEach(file => {
            if (!file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = e => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <img src="${e.target.result}"
                         class="w-full h-40 object-cover rounded-lg shadow"/>
                `;
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }
</script>


</body>
</html>
