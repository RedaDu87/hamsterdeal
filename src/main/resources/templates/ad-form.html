<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="fr"
      th:replace="~{fragments/_layout :: base(~{::body})}">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <title th:with="isEdit=${ad != null and ad.id != null}"
           th:text="${isEdit} ? #{ad.form.title.edit} : #{ad.form.title.new}">
        Annonce
    </title>

    <!-- Tailwind via CDN (si tu utilises dÃ©jÃ  Tailwind autrement, supprime ceci) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSRF (Spring Security) : utile pour les POST AJAX de suppression -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
</head>

<body class="bg-gray-50">
<div class="container mx-auto mt-4 px-4">
    <button onclick="window.history.back()"
            class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-4 rounded-xl shadow font-semibold"
            th:text="#{ad.back}">
    </button>
</div>
<div class="max-w-5xl mx-auto px-4 md:px-6 py-8">
    <div class="bg-white/80 backdrop-blur rounded-2xl shadow-lg overflow-hidden">

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 md:p-8 text-white"
             th:with="isEdit=${ad != null and ad.id != null}">
            <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight"
                th:text="${isEdit} ? #{ad.form.header.edit} : #{ad.form.header.new}">
                Nouvelle annonce
            </h1>
            <p class="opacity-90 mt-1 text-sm md:text-base"
               th:text="${isEdit} ? #{ad.form.header.subtitle.edit} : #{ad.form.header.subtitle.new}">
                DÃ©cris ton article, ajoute des photos et publie en 1 clic.
            </p>
        </div>

        <!-- Form (unique) -->
        <form th:action="${ad != null and ad.id != null} ? @{/ad/update/{id}(id=${ad.id})} : @{/ad/save}"
              th:object="${ad}"
              method="post"
              enctype="multipart/form-data"
              class="p-6 md:p-8 space-y-8">

            <!-- ID cachÃ© -->
            <input type="hidden" th:if="${ad != null and ad.id != null}" th:field="*{id}"/>

            <!-- Titre / Description -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700" th:text="#{ad.form.field.title}">Titre</span>
                    <input type="text" th:field="*{title}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block md:col-span-2">
                    <span class="font-semibold text-sm text-gray-700"
                          th:text="#{ad.form.field.description}">Description</span>
                    <textarea th:field="*{description}" rows="4" required
                              class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                              th:placeholder="#{ad.form.placeholder.description}"></textarea>
                </label>
            </section>

            <!-- Prix / CatÃ©gorie -->
            <section class="grid gap-6 md:grid-cols-2">
                <label class="block">
                    <span class="font-semibold text-sm text-gray-700" th:text="#{ad.form.field.price}">Prix (CHF)</span>
                    <input type="number" step="0.01" min="0" th:field="*{price}" required
                           class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                </label>

                <label class="block">
                    <span class="font-semibold text-sm text-gray-700"
                          th:text="#{ad.form.field.category}">CatÃ©gorie</span>
                    <select th:field="*{category}" required
                            class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="" th:text="#{ad.form.category.choose}">Choisirâ€¦</option>
                        <option value="car" th:text="#{ad.form.category.car}">Voitures</option>
                        <option value="electronics" th:text="#{ad.form.category.electronics}">Ã‰lectronique</option>
                        <option value="home" th:text="#{ad.form.category.home}">Maison</option>
                        <option value="fashion" th:text="#{ad.form.category.fashion}">Mode</option>
                        <option value="sports" th:text="#{ad.form.category.sports}">Sport</option>
                        <option value="toys" th:text="#{ad.form.category.toys}">Jouets</option>
                        <option value="books" th:text="#{ad.form.category.books}">Livres</option>
                        <option value="music" th:text="#{ad.form.category.music}">Musique</option>
                        <option value="tools" th:text="#{ad.form.category.tools}">Outils</option>
                        <option value="garden" th:text="#{ad.form.category.garden}">Jardin</option>
                        <option value="pets" th:text="#{ad.form.category.pets}">Animaux</option>
                        <option value="jobs" th:text="#{ad.form.category.jobs}">Emplois</option>
                        <option value="services" th:text="#{ad.form.category.services}">Services</option>
                        <option value="realestate" th:text="#{ad.form.category.realestate}">Immobilier</option>
                        <option value="collectibles" th:text="#{ad.form.category.collectibles}">Collections</option>
                        <option value="other" th:text="#{ad.form.category.other}">Autre</option>
                    </select>
                </label>
            </section>

            <!-- ================= Ã‰LECTRONIQUE ================= -->
            <section id="electronicsSection"
                     class="space-y-6 border-t pt-6 hidden">

                <h2 class="text-lg font-semibold text-gray-800">
                    Informations Ã©lectroniques
                </h2>

                <section class="grid gap-6 md:grid-cols-2">

                    <!-- Type (ENUM) -->
                    <label class="block">
            <span class="font-semibold text-sm text-gray-700">
                Type dâ€™appareil
            </span>

                        <select th:field="*{electronics.type}"
                                class="mt-1 w-full p-3 rounded-lg border border-gray-300 bg-white
                           focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">

                            <option value="">Choisirâ€¦</option>

                            <option th:each="t : ${electronicsTypes}"
                                    th:value="${t.name()}"
                                    th:text="${#strings.capitalize(t.name().toLowerCase())}">
                            </option>
                        </select>
                    </label>

                    <!-- ModÃ¨le -->
                    <label class="block">
            <span class="font-semibold text-sm text-gray-700">
                ModÃ¨le
            </span>

                        <input type="text"
                               th:field="*{electronics.model}"
                               placeholder="iPhone 14, Galaxy S23, MacBook Proâ€¦"
                               class="mt-1 w-full p-3 rounded-lg border border-gray-300
                          focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"/>
                    </label>

                </section>
            </section>


            <!-- Localisation -->
            <section class="grid gap-6 md:grid-cols-2">

                <section class="grid gap-6 md:grid-cols-2">
                    <section class="grid gap-6 md:grid-cols-2">

                        <!-- NPA ou Ville -->
                        <label class="block md:col-span-2">
        <span class="font-semibold text-sm text-gray-700">
            NPA ou Ville
        </span>

                            <input type="text"
                                   id="locationInput"
                                   list="locationList"
                                   placeholder="1000 ou Lausanne"
                                   class="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500"/>

                            <datalist id="locationList"></datalist>
                        </label>

                        <!-- Canton (auto, readonly) -->
                        <label class="block">
        <span class="font-semibold text-sm text-gray-700">
            Canton
        </span>

                            <input type="text"
                                   id="cantonDisplay"
                                   readonly
                                   class="mt-1 w-full p-3 rounded-lg border border-gray-200 bg-gray-100 text-gray-600"/>
                        </label>

                    </section>

                    <!-- champs rÃ©ellement soumis -->
                    <input type="hidden" th:field="*{npa}" id="npaField"/>
                    <input type="hidden" th:field="*{city}" id="cityField"/>
                    <input type="hidden" th:field="*{canton}" id="cantonField"/>


                </section>

            <!-- Photos existantes (Ã©dition) -->
            <section th:if="${ad != null and ad.id != null}"
                     th:with="existingCount=${(images != null) ? #lists.size(images) : 0}"
                     class="space-y-3">

                <div class="flex items-center justify-between gap-3 flex-wrap">
                    <h2 class="text-lg font-semibold" th:text="#{ad.form.existingPhotos.title}">Photos existantes</h2>
                    <p class="text-sm text-gray-600">
                        <span th:text="#{ad.form.existingPhotos.totalLabel}">Total :</span>
                        <span class="font-semibold" id="existingCountText" th:text="${existingCount}">0</span>
                        <span th:text="#{ad.form.existingPhotos.maxSuffix}">/ 20</span>
                    </p>
                </div>

                <div id="existingGrid"
                     class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"
                     th:if="${images != null and !#lists.isEmpty(images)}">

                    <div th:each="img, stat : ${images}"
                         class="relative group"
                         th:attr="data-idx=${stat.index}">
                        <img th:src="${img.url}"
                             th:alt="${img.alt}"
                             class="rounded-lg shadow-md w-full h-40 object-cover"/>

                        <!-- PAS DE FORM ICI : suppression en AJAX -->
                        <button type="button"
                                class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded hover:bg-red-700 shadow"
                                th:attr="data-del-url=@{/ad/{adId}/image/{idx}/delete(adId=${ad.id}, idx=${stat.index})}"
                                onclick="deleteExistingImage(this)"
                                th:text="#{ad.form.existingPhotos.deleteButton}">
                            Supprimer
                        </button>
                    </div>
                </div>

                <div class="text-sm text-gray-500" th:if="${images == null or #lists.isEmpty(images)}"
                     th:text="#{ad.form.existingPhotos.empty}">
                    Aucune photo existante.
                </div>
            </section>

            <!-- Upload nouvelles images -->
            <section class="space-y-3"
                     th:with="existingCount=${(images != null) ? #lists.size(images) : 0}">
                <div class="flex items-center justify-between flex-wrap gap-3">
                    <h2 class="text-lg font-semibold" th:text="#{ad.form.addPhotos.title}">Ajouter des photos</h2>
                    <p class="text-sm text-gray-700">
                        <span th:text="#{ad.form.addPhotos.remaining.prefix}">Il vous reste</span>
                        <span id="remainingCount"
                              class="font-semibold"
                              th:text="${20 - existingCount}">20</span>
                        <span th:text="#{ad.form.addPhotos.remaining.suffix}">photo(s) Ã  ajouter</span>
                    </p>
                </div>

                <!-- Dropzone -->
                <div id="dropzone"
                     class="relative flex flex-col items-center justify-center
                    border-2 border-dashed border-gray-300
                    rounded-2xl p-8 text-center cursor-pointer
                    hover:border-blue-500 hover:bg-blue-50 transition"
                     th:attr="data-existing-count=${existingCount}">

                    <!-- INPUT FILE (Spring) -->
                    <input id="fileInput"
                           type="file"
                           name="files"
                           multiple
                           accept="image/*"
                           class="absolute inset-0 opacity-0 cursor-pointer"/>

                    <svg class="w-12 h-12 text-gray-400 mb-2" fill="none" stroke="currentColor"
                         viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16V4m10 12V4M3 20h18"/>
                    </svg>

                    <p class="text-sm text-gray-600">
                        <strong th:text="#{ad.form.dropzone.strong}">Glissez-dÃ©posez</strong>
                        <span th:text="#{ad.form.dropzone.text1}">vos images ici</span><br>
                        <span th:text="#{ad.form.dropzone.or}">ou</span>
                        <span class="text-blue-600 underline" th:text="#{ad.form.dropzone.click}">cliquez pour sÃ©lectionner</span>
                    </p>

                    <p class="mt-2 text-xs text-gray-500">
                        <span th:text="#{ad.form.dropzone.max.prefix}">Maximum</span>
                        <span class="font-semibold">20</span>
                        <span th:text="#{ad.form.dropzone.max.suffix}">photos par annonce (existantes + nouvelles).</span>
                    </p>
                </div>

                <!-- Message / Alerte -->
                <div id="uploadHint"
                     class="hidden text-sm rounded-lg border border-amber-200 bg-amber-50 text-amber-800 px-3 py-2"></div>

                <!-- PREVIEW nouvelles images -->
                <div id="preview"
                     class="mt-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
            </section>

            <!-- Bouton -->
            <div class="pt-2" th:with="isEdit=${ad != null and ad.id != null}">
                <button type="submit"
                        class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-xl shadow transition"
                        th:text="${isEdit} ? #{ad.form.submit.update} : #{ad.form.submit.publish}">
                    Publier lâ€™annonce
                </button>
            </div>

        </form>
    </div>
</div>

<script th:inline="javascript">
    // ====== CONFIG ======
    const MAX_TOTAL = 20;

    // ====== I18N STRINGS ======
    const MSG_CONFIRM_DELETE = /*[[#{ad.js.confirmDeleteExisting}]]*/ "Supprimer cette photo ?";
    const MSG_DELETE_ERROR = /*[[#{ad.js.alertDeleteError}]]*/ "Erreur lors de la suppression.";
    const MSG_NO_IMAGE = /*[[#{ad.js.hintNoImageDetected}]]*/ "Aucun fichier image dÃ©tectÃ©.";
    const MSG_LIMIT_REACHED = /*[[#{ad.js.hintLimitAlreadyReached}]]*/ "Tu as dÃ©jÃ  atteint la limite de 20 photos (existantes + nouvelles).";
    const MSG_LIMIT_ADDED_TPL = /*[[#{ad.js.hintLimitAddedOnly}]]*/ "Limite atteinte : seules {0} photo(s) ont Ã©tÃ© ajoutÃ©es.";

    function formatMsgLimitAddedOnly(n) {
        return String(MSG_LIMIT_ADDED_TPL).replace('{0}', String(n));
    }

    // ====== CSRF (Spring Security) for AJAX POST ======
    function getCsrf() {
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || '';
        return { token, header };
    }

    // ====== DELETE EXISTING IMAGE (AJAX, no nested form) ======
    async function deleteExistingImage(btn) {
        if (!confirm(MSG_CONFIRM_DELETE)) return;

        const url = btn.dataset.delUrl;
        if (!url) return;

        const { token, header } = getCsrf();
        const headers = { 'X-Requested-With': 'XMLHttpRequest' };
        if (token && header) headers[header] = token;

        try {
            const res = await fetch(url, { method: 'POST', headers });
            if (!res.ok) throw new Error("Delete failed");

            // Remove card
            const card = btn.closest('[data-idx]');
            if (card) {
                card.style.transition = 'opacity .2s';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 200);
            }

            // Update counters
            const dropzone = document.getElementById('dropzone');
            const existingCountText = document.getElementById('existingCountText');
            const remainingCountEl = document.getElementById('remainingCount');

            if (dropzone && remainingCountEl) {
                const currentExisting = parseInt(dropzone.dataset.existingCount || '0', 10);
                const newExisting = Math.max(0, currentExisting - 1);
                dropzone.dataset.existingCount = String(newExisting);

                if (existingCountText) existingCountText.textContent = String(newExisting);

                const selectedNew = window.__selectedFiles ? window.__selectedFiles.length : 0;
                remainingCountEl.textContent = String(Math.max(0, MAX_TOTAL - newExisting - selectedNew));
            }

        } catch (e) {
            alert(MSG_DELETE_ERROR);
            console.error(e);
        }
    }

    // ====== UPLOAD NEW IMAGES (preview + enforce max 20 total) ======
    (function initUploader() {
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const remainingCountEl = document.getElementById('remainingCount');
        const uploadHint = document.getElementById('uploadHint');

        if (!dropzone || !fileInput || !preview || !remainingCountEl || !uploadHint) return;

        let selectedFiles = []; // new images only
        window.__selectedFiles = selectedFiles;

        function existingCount() {
            return parseInt(dropzone.dataset.existingCount || '0', 10);
        }

        function setHint(msg) {
            if (!msg) {
                uploadHint.classList.add('hidden');
                uploadHint.textContent = '';
                return;
            }
            uploadHint.classList.remove('hidden');
            uploadHint.textContent = msg;
        }

        function updateRemainingUI() {
            const remain = Math.max(0, MAX_TOTAL - existingCount() - selectedFiles.length);
            remainingCountEl.textContent = String(remain);
        }

        function syncInputFiles() {
            const dt = new DataTransfer();
            selectedFiles.forEach(f => dt.items.add(f));
            fileInput.files = dt.files;
            window.__selectedFiles = selectedFiles;
        }

        function renderPreview() {
            preview.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = e => {
                    const card = document.createElement('div');
                    card.className = 'relative';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'rounded-lg shadow-md w-full h-40 object-cover';

                    const delBtn = document.createElement('button');
                    delBtn.type = 'button';
                    delBtn.innerHTML = 'Ã—';
                    delBtn.className =
                        'absolute top-1 right-1 bg-red-600 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-700 shadow';

                    delBtn.addEventListener('click', () => {
                        selectedFiles.splice(index, 1);
                        syncInputFiles();
                        updateRemainingUI();
                        renderPreview();
                        setHint('');
                    });

                    card.appendChild(img);
                    card.appendChild(delBtn);
                    preview.appendChild(card);
                };
                reader.readAsDataURL(file);
            });
        }

        function addFiles(files) {
            const imgFiles = files.filter(f => f && f.type && f.type.startsWith('image/'));

            if (imgFiles.length === 0) {
                setHint(MSG_NO_IMAGE);
                return;
            }

            const free = MAX_TOTAL - existingCount() - selectedFiles.length;
            if (free <= 0) {
                setHint(MSG_LIMIT_REACHED);
                return;
            }

            let toAdd = imgFiles;
            if (imgFiles.length > free) {
                toAdd = imgFiles.slice(0, free);
                setHint(formatMsgLimitAddedOnly(free));
            } else {
                setHint('');
            }

            selectedFiles = selectedFiles.concat(toAdd);

            syncInputFiles();
            updateRemainingUI();
            renderPreview();
        }

        ['dragenter', 'dragover'].forEach(evt => {
            dropzone.addEventListener(evt, e => {
                e.preventDefault();
                dropzone.classList.add('border-blue-500', 'bg-blue-50');
            });
        });
        ['dragleave', 'drop'].forEach(evt => {
            dropzone.addEventListener(evt, e => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            });
        });

        dropzone.addEventListener('drop', e => {
            const files = Array.from(e.dataTransfer.files || []);
            addFiles(files);
        });

        fileInput.addEventListener('change', () => {
            const files = Array.from(fileInput.files || []);
            addFiles(files);

            fileInput.value = '';
            syncInputFiles();
        });

        updateRemainingUI();
    })();
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const input = document.getElementById("locationInput");
        const list = document.getElementById("locationList");

        const npaField = document.getElementById("npaField");
        const cityField = document.getElementById("cityField");
        const cantonField = document.getElementById("cantonField");
        const cantonDisplay = document.getElementById("cantonDisplay");

        let lastResults = [];

        // ðŸ”¹ Recherche dynamique UNIQUEMENT pendant la frappe libre
        input.addEventListener("input", async () => {
            const q = input.value.trim();

            // ðŸš« si dÃ©jÃ  sÃ©lectionnÃ© "Ville (1008)" â†’ STOP
            if (/^.+\s*\(\d{4}\)$/.test(q)) {
                return;
            }

            list.innerHTML = "";
            lastResults = [];

            if (q.length < 2) return;

            try {
                const res = await fetch(`/api/npa/search?q=${encodeURIComponent(q)}`);
                if (!res.ok) return;

                lastResults = await res.json();

                lastResults.forEach(item => {
                    const option = document.createElement("option");
                    option.value = `${item.ville} (${item.npa})`;
                    list.appendChild(option);
                });

            } catch (e) {
                console.error("Erreur NPA search", e);
            }
        });

        // ðŸ”¹ SÃ©lection utilisateur â†’ remplissage auto
        input.addEventListener("change", () => {
            const matchInput = input.value.match(/^(.+?)\s*\((\d{4})\)$/);
            if (!matchInput) return;

            if (!lastResults || lastResults.length === 0) return;

            const ref = lastResults[0];

            npaField.value = ref.npa;
            cityField.value = ref.ville;
            cantonField.value = ref.canton;

            cantonDisplay.value = ref.canton;
        });

    });
</script>


<script>
    document.addEventListener("DOMContentLoaded", () => {

        const categorySelect = document.querySelector('[name="category"]');
        const electronicsSection = document.getElementById('electronicsSection');

        function updateVisibility() {
            if (!categorySelect || !electronicsSection) return;

            if (categorySelect.value === 'electronics') {
                electronicsSection.classList.remove('hidden');
            } else {
                electronicsSection.classList.add('hidden');
            }
        }

        // ðŸ”¹ au chargement (Ã©dition)
        updateVisibility();

        // ðŸ”¹ au changement utilisateur
        categorySelect.addEventListener('change', updateVisibility);
    });
</script>

<div class="container mx-auto mt-4 px-4">
    <button onclick="window.history.back()"
            class="w-full bg-gray-200 hover:bg-gray-300 px-4 py-4 rounded-xl shadow font-semibold"
            th:text="#{ad.back}">
    </button>
</div>
</body>
</html>
