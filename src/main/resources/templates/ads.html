<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="fr"
      th:replace="~{fragments/_layout :: base(~{::body})}">
<body class="bg-gray-50">

<!-- HERO -->
<!-- <section class="bg-gradient-to-r from-green-500 to-blue-600 text-white py-12 shadow-md mb-6">
    <div class="max-w-6xl mx-auto px-4 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold mb-3 drop-shadow">
            ğŸ” Parcourir les <span class="text-yellow-300">Annonces</span>
        </h1>
        <p class="text-lg text-white/90">Affinez votre recherche et trouvez rapidement ce quâ€™il vous faut</p>
    </div>
</section> -->
<!-- Collapse Toggle (mobile only) -->
<div class="sm:hidden flex justify-between items-center mb-3 px-2">
    <button id="toggleFiltersBtn"
            class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg flex justify-between items-center">
        <span>Filtres</span>
        <svg id="filterArrow" class="h-5 w-5 transform transition-transform duration-300"
             fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
        </svg>
    </button>
</div>

<!-- FORMULAIRE DE RECHERCHE -->
<form id="advFilter"
      class="hidden sm:grid max-w-6xl mx-auto grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4
             bg-white p-4 rounded-lg shadow-lg"
      method="get"
      th:action="@{/ads}">


    <!-- Recherche globale -->
    <div class="col-span-1 sm:col-span-2 lg:col-span-4">
        <input class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-400"
               type="text" name="q" placeholder="Ex: iPhone 14, Renault Clio, appart 3 piÃ¨cesâ€¦"
               th:value="${q}" />
    </div>


    <!-- CatÃ©gorie -->
    <div class="relative">
        <select
                class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-700 appearance-none
                   focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
                name="category" id="fltCategory">

            <option value="">Toutes catÃ©gories</option>
            <option value="car" th:selected="${category=='car'}">ğŸš— Voitures</option>
            <option value="electronics" th:selected="${category=='electronics'}">ğŸ’» Ã‰lectronique</option>
            <option value="home" th:selected="${category=='home'}">ğŸ  Maison</option>
            <option value="fashion" th:selected="${category=='fashion'}">ğŸ‘— Mode</option>
            <option value="sports" th:selected="${category=='sports'}">ğŸ€ Sport</option>
            <option value="toys" th:selected="${category=='toys'}">ğŸ§¸ Jouets</option>
            <option value="books" th:selected="${category=='books'}">ğŸ“š Livres</option>
            <option value="music" th:selected="${category=='music'}">ğŸµ Musique</option>
            <option value="tools" th:selected="${category=='tools'}">ğŸ› ï¸ Outils</option>
            <option value="garden" th:selected="${category=='garden'}">ğŸŒ± Jardin</option>
            <option value="pets" th:selected="${category=='pets'}">ğŸ¾ Animaux</option>
            <option value="jobs" th:selected="${category=='jobs'}">ğŸ’¼ Emplois</option>
            <option value="services" th:selected="${category=='services'}">ğŸ›ï¸ Services</option>
            <option value="realestate" th:selected="${category=='realestate'}">ğŸ¢ Immobilier</option>
            <option value="collectibles" th:selected="${category=='collectibles'}">ğŸ–¼ï¸ Collections</option>
        </select>

        <!-- IcÃ´ne flÃ¨che -->
        <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </span>
    </div>


    <!-- Canton -->
    <div class="relative">
        <select
                class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-700 appearance-none
                   focus:ring-2 focus:ring-purple-500 focus:border-purple-500 cursor-pointer"
                name="canton">

            <option value="">Tous cantons</option>
            <option value="VD" th:selected="${canton=='VD'}">Vaud (VD)</option>
            <option value="GE" th:selected="${canton=='GE'}">GenÃ¨ve (GE)</option>
            <option value="ZH" th:selected="${canton=='ZH'}">Zurich (ZH)</option>
            <option value="BE" th:selected="${canton=='BE'}">Berne (BE)</option>
        </select>

        <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </span>
    </div>


    <!-- Prix -->
    <input class="w-full p-3 border border-gray-300 rounded-lg" type="number" name="priceMin"
           th:value="${priceMin}" placeholder="Min CHF" />

    <input class="w-full p-3 border border-gray-300 rounded-lg" type="number" name="priceMax"
           th:value="${priceMax}" placeholder="Max CHF" />


    <!-- Tri -->
    <div class="relative">
        <select
                class="w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-700 appearance-none
                   focus:ring-2 focus:ring-amber-500 focus:border-amber-500 cursor-pointer"
                name="sort" id="sortSelect"
                onchange="document.getElementById('advFilter').submit()">

            <option th:selected="${sort == 'createdAt' and dir == 'desc'}" value="createdAt,desc">ğŸ•“ Plus rÃ©centes</option>
            <option th:selected="${sort == 'createdAt' and dir == 'asc'}" value="createdAt,asc">ğŸ•“ Plus anciennes</option>
            <option th:selected="${sort == 'price' and dir == 'asc'}" value="price,asc">ğŸ’° Prix croissant</option>
            <option th:selected="${sort == 'price' and dir == 'desc'}" value="price,desc">ğŸ’° Prix dÃ©croissant</option>
        </select>

        <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
            </svg>
        </span>
    </div>


    <!-- Bouton -->
    <div class="col-span-1 sm:col-span-2 lg:col-span-4 flex justify-end">
        <button class="bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700
                       text-white px-6 py-3 rounded-lg font-semibold shadow-md transition w-full sm:w-auto">
            Appliquer filtres
        </button>
    </div>

</form>


<!-- SCRIPT facettes -->
<script>
    (function(){
        const catSel = document.getElementById('fltCategory');
        const facets = Array.from(document.querySelectorAll('[data-facet]'));

        function toggleFacets(v){
            facets.forEach(f => {
                if(f.dataset.facet === v) {
                    f.classList.remove('hidden');
                } else {
                    f.classList.add('hidden');
                }
            });
        }
        toggleFacets(catSel.value);
        catSel.addEventListener('change', () => toggleFacets(catSel.value));
    })();
</script>

<!-- RESULTATS ANNONCES -->
<!-- Message si aucun rÃ©sultat -->
<div th:if="${result.totalElements == 0}"
     class="max-w-3xl mx-auto mt-10 p-6 text-center bg-white rounded-xl shadow-lg">

    <h2 class="text-2xl font-bold text-gray-700 mb-3">Aucun rÃ©sultat</h2>

    <p class="text-gray-500 text-lg">
        Aucun rÃ©sultat ne correspond Ã  votre recherche.
    </p>

    <p class="text-gray-400 mt-2 text-sm">
        Essayez d'Ã©largir vos critÃ¨res ou de modifier vos filtres.
    </p>

    <a href="/ads"
       class="inline-block mt-5 px-6 py-3 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
        RÃ©initialiser les filtres
    </a>
</div>

<!-- RESULTATS ANNONCES -->
<div class="w-full px-4 mx-auto grid gap-4
            grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 2xl:grid-cols-8 mt-8">
    <article th:each="ad : ${result.content}"
             class="bg-white rounded-lg shadow hover:shadow-lg overflow-hidden group transition transform hover:-translate-y-1">
        <a th:href="@{'/ad/' + ${ad.id}}">
            <div class="relative">
                <img th:if="${ad.images != null and !ad.images.isEmpty()}"
                     th:src="${ad.images.get(0).url}"
                     alt=""
                     class="w-full h-40 object-cover group-hover:scale-105 transition duration-300" />
                <span class="absolute bottom-2 right-2 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded">
                    <span th:text="${ad.price + ' CHF'}"></span>
                </span>
            </div>
            <div class="p-3">
                <h3 class="font-semibold text-sm line-clamp-1" th:text="${ad.title}"></h3>
                <p class="text-gray-500 text-xs line-clamp-2" th:text="${ad.description}"></p>
            </div>
        </a>
    </article>
</div>

<!-- PAGINATION -->
<div class="flex justify-center mt-8">
  <nav class="flex flex-wrap gap-2 items-center text-sm bg-white p-3 rounded-lg shadow-md">

    <!-- PrÃ©cÃ©dent -->
<a th:if="${result.page > 0}"
   th:href="@{/ads(
        page=${result.page - 1},
        size=${result.size},
        q=${q},
        category=${category},
        canton=${canton},
    priceMin=${priceMin},
    priceMax=${priceMax},
        sort=${sort + ',' + dir}
   )}"
   class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Â« PrÃ©cÃ©dent</a>

<!-- NumÃ©ro page 1 -->
<a th:if="${result.totalPages > 0}"
   th:href="@{/ads(
        page=0,
        size=${result.size},
        q=${q},
        category=${category},
        canton=${canton},
    priceMin=${priceMin},
    priceMax=${priceMax},
        sort=${sort + ',' + dir}
   )}"
   th:text="1"
   th:classappend="${result.page == 0} ? ' bg-green-500 text-white ' : ' bg-gray-200 hover:bg-gray-300 '"
   class="px-3 py-1 rounded cursor-pointer"></a>

<!-- Pages autour -->
<a th:each="i : ${#numbers.sequence(result.page - 1 , result.page + 1 )}"
   th:if="${i > 0 and i < result.totalPages - 1}"
   th:href="@{/ads(
        page=${i},
        size=${result.size},
        q=${q},
        category=${category},
        canton=${canton},
    priceMin=${priceMin},
    priceMax=${priceMax},
        sort=${sort + ',' + dir}
   )}"
   th:text="${i + 1}"
   th:classappend="${i == result.page} ? ' bg-green-500 text-white ' : ' bg-gray-200 hover:bg-gray-300 '"
   class="px-3 py-1 rounded cursor-pointer"></a>

<!-- DerniÃ¨re page -->
<a th:if="${result.totalPages > 1}"
   th:href="@{/ads(
        page=${result.totalPages - 1},
        size=${result.size},
        q=${q},
        category=${category},
        canton=${canton},
    priceMin=${priceMin},
    priceMax=${priceMax},
        sort=${sort + ',' + dir}
   )}"
   th:text="${result.totalPages}"
   th:classappend="${result.page == result.totalPages - 1} ? ' bg-green-500 text-white ' : ' bg-gray-200 hover:bg-gray-300 '"
   class="px-3 py-1 rounded cursor-pointer"></a>

<!-- Suivant -->
<a th:if="${result.page + 1 < result.totalPages}"
   th:href="@{/ads(
        page=${result.page + 1},
        size=${result.size},
        q=${q},
        category=${category},
        canton=${canton},
    priceMin=${priceMin},
    priceMax=${priceMax},
        sort=${sort + ',' + dir}
   )}"
   class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Suivant Â»</a>

    <!-- Aller Ã  la page -->
<form id="gotoPageForm" th:action="@{/ads}" method="get" class="flex items-center gap-2 ml-4">
  <label for="gotoPageInput" class="text-gray-600 text-sm">Aller Ã  la page :</label>

  <!-- Champ visible (1-based pour lâ€™utilisateur) -->
  <input id="gotoPageInput"
         type="number"
         min="1"
         th:attr="max=${result.totalPages}"
         th:value="${result.page + 1}"
         class="w-16 p-1 border rounded text-center focus:ring-2 focus:ring-green-400"
         required />

  <!-- Champ cachÃ© (envoyÃ© au backend) -->
  <input type="hidden" name="page" id="hiddenPageInput" th:value="${result.page}" />

  <!-- Autres filtres conservÃ©s -->
  <input type="hidden" name="size" th:value="${result.size}" />
  <input type="hidden" name="q" th:value="${q}" />
  <input type="hidden" name="category" th:value="${category}" />
  <input type="hidden" name="canton" th:value="${canton}" />
  <input type="hidden" name="priceMin" th:value="${priceMin}" />
  <input type="hidden" name="priceMax" th:value="${priceMax}" />
  <input type="hidden" name="sort" th:value="${sort + ',' + dir}" />

  <button type="submit"
          class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
    OK
  </button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const gotoForm = document.getElementById('gotoPageForm');
  const visibleInput = document.getElementById('gotoPageInput');
  const hiddenInput = document.getElementById('hiddenPageInput');

  gotoForm.addEventListener('submit', () => {
    const val = parseInt(visibleInput.value, 10);
    if (!isNaN(val) && val > 0) {
      hiddenInput.value = val - 1; // on modifie seulement le champ cachÃ©
    }
  });
});
</script>


  </nav>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const toggleBtn = document.getElementById("toggleFiltersBtn");
        const filterForm = document.getElementById("advFilter");
        const arrow = document.getElementById("filterArrow");

        // Toggle bouton
        toggleBtn.addEventListener("click", () => {
            const isHidden = filterForm.classList.contains("hidden");

            if (isHidden) {
                filterForm.classList.remove("hidden");
                arrow.classList.add("rotate-180");
            } else {
                filterForm.classList.add("hidden");
                arrow.classList.remove("rotate-180");
            }
        });

        // Auto collapse aprÃ¨s "Appliquer filtres"
        const applyBtn = filterForm.querySelector("button[type='submit']");
        applyBtn.addEventListener("click", () => {
            if (window.innerWidth < 640) { // mobile uniquement
                filterForm.classList.add("hidden");
                arrow.classList.remove("rotate-180");
            }
        });
    });
</script>

</body>
</html>
