<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      lang="fr"
      th:replace="~{fragments/_layout :: base(~{::body})}">
<body class="bg-gray-50">

<div class="max-w-6xl mx-auto p-4 sm:p-8 space-y-10">

    <!-- HEADER PROFIL -->
    <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-6 rounded-2xl shadow-lg">
        <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-6 text-center sm:text-left">

            <!-- Avatar -->
            <div class="mx-auto sm:mx-0 w-24 h-24 rounded-full overflow-hidden border-4 border-white shadow-md flex items-center justify-center bg-white">
                <img th:if="${user.photoUrl != null}"
                     th:src="@{${user.photoUrl}}"
                     th:alt="#{profile.avatar.alt}"
                     class="w-full h-full object-cover"/>

                <!-- Première lettre du prénom -->
                <span th:if="${user.photoUrl == null and user.firstName != null}"
                      th:text="${user.firstName.substring(0,1)}"
                      class="text-4xl font-bold text-orange-600">
    </span>

                <!-- Fallback -->
                <span th:if="${user.photoUrl == null and user.firstName == null}"
                      th:text="#{profile.avatar.fallback}"
                      class="text-4xl font-bold text-orange-600">
    </span>
            </div>


            <!-- Infos -->
            <div class="mt-4 sm:mt-0">
                <h1 class="text-2xl sm:text-3xl font-extrabold"
                    th:text="${user.firstName + ' ' + user.lastName}">
                </h1>
                <p class="text-sm opacity-90" th:text="${user.email}"></p>
                <p class="text-sm opacity-90" th:text="${user.phone}"></p>
            </div>
        </div>
    </div>

    <!-- FORMULAIRE PROFIL -->
    <div class="bg-white p-6 rounded-xl shadow-md">
        <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-700"
            th:text="#{profile.form.title}">
        </h2>

        <form th:action="@{/profile}" th:object="${user}" method="post" enctype="multipart/form-data" class="space-y-6">

            <!-- Photo -->
            <div>
                <label class="block text-sm font-medium text-gray-700"
                       th:text="#{profile.form.photo}">
                </label>
                <input type="file" name="photoFile" accept="image/*"
                       class="mt-2 w-full border rounded-lg p-2 file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0 file:text-sm file:font-semibold
                              file:bg-orange-50 file:text-orange-600 hover:file:bg-orange-100"/>
            </div>

            <!-- Nom & prénom -->
            <div class="grid sm:grid-cols-2 gap-4">
                <label>
                    <span class="block text-sm font-medium text-gray-700"
                          th:text="#{profile.form.firstname}">
                    </span>
                    <input type="text" th:field="*{firstName}"
                           class="mt-2 border rounded-lg p-3 w-full focus:ring-2 focus:ring-orange-500"/>
                </label>

                <label>
                    <span class="block text-sm font-medium text-gray-700"
                          th:text="#{profile.form.lastname}">
                    </span>
                    <input type="text" th:field="*{lastName}"
                           class="mt-2 border rounded-lg p-3 w-full focus:ring-2 focus:ring-orange-500"/>
                </label>
            </div>

            <!-- Email & Téléphone -->
            <div class="grid sm:grid-cols-2 gap-4">
                <label>
                    <span class="block text-sm font-medium text-gray-700"
                          th:text="#{profile.form.email}">
                    </span>
                    <input type="text" th:value="${user.email}" disabled
                           class="mt-2 border rounded-lg p-3 w-full bg-gray-100"/>
                </label>

                <label>
                    <span class="block text-sm font-medium text-gray-700"
                          th:text="#{profile.form.phone}">
                    </span>
                    <input type="text" th:field="*{phone}"
                           th:placeholder="#{profile.form.phone.placeholder}"
                           class="mt-2 border rounded-lg p-3 w-full focus:ring-2 focus:ring-orange-500"/>
                </label>
            </div>

            <div class="flex justify-end">
                <button type="submit"
                        class="bg-gradient-to-r from-orange-500 to-red-600 text-white font-semibold px-6 py-2 rounded-lg shadow hover:scale-105 transition"
                        th:text="#{profile.form.submit}">
                </button>
            </div>
        </form>
    </div>

    <!-- FILTRES -->
    <div class="bg-white p-6 rounded-xl shadow-md" id="filtersCard">
        <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-700"
            th:text="#{profile.filters.title}">
        </h2>

        <form id="filterForm" th:action="@{/profile}" method="get"
              class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">

            <input type="hidden" name="page" value="0"/>
            <input type="hidden" name="size" th:value="${param.size != null ? param.size[0] : '10'}"/>

            <input type="text" name="title" th:value="${param.title}"
                   th:placeholder="#{profile.filters.title.placeholder}"
                   class="border rounded-lg p-2 focus:ring-2 focus:ring-orange-500"/>

            <input type="text" name="category" th:value="${param.category}"
                   th:placeholder="#{profile.filters.category.placeholder}"
                   class="border rounded-lg p-2 focus:ring-2 focus:ring-orange-500"/>

            <div class="flex space-x-2">
                <input type="number" name="minPrice" th:value="${param.minPrice}"
                       th:placeholder="#{profile.filters.price.min}"
                       class="w-1/2 border rounded-lg p-2 focus:ring-2 focus:ring-orange-500"/>

                <input type="number" name="maxPrice" th:value="${param.maxPrice}"
                       th:placeholder="#{profile.filters.price.max}"
                       class="w-1/2 border rounded-lg p-2 focus:ring-2 focus:ring-orange-500"/>
            </div>

            <input type="date" name="fromDate" th:value="${param.fromDate}"
                   class="border rounded-lg p-2 focus:ring-2 focus:ring-orange-500"/>

            <input type="date" name="toDate" th:value="${param.toDate}"
                   class="border rounded-lg p-2 focus:ring-2 focus:ring-orange-500"/>

            <div class="sm:col-span-2 md:col-span-5 flex justify-end">
                <button type="submit"
                        class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition w-full sm:w-auto"
                        th:text="#{profile.filters.submit}">
                </button>
            </div>
        </form>
    </div>

    <!-- LISTE DES ANNONCES -->
    <div id="adsSection" class="space-y-3">

        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <table class="w-full border-collapse text-sm">
                <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-semibold">
                <tr>
                    <th class="p-3 text-left" th:text="#{profile.table.title}"></th>
                    <th class="p-3 text-right" th:text="#{profile.table.price}"></th>
                    <th class="p-3 text-left hidden sm:table-cell" th:text="#{profile.table.category}"></th>
                    <th class="p-3 text-left hidden md:table-cell" th:text="#{profile.table.published}"></th>
                    <th class="p-3 text-center" th:text="#{profile.table.actions}"></th>
                </tr>
                </thead>

                <tbody class="divide-y divide-gray-200">
                <tr th:each="ad : ${ads}" class="hover:bg-gray-50 transition">

                    <td class="p-3">
                        <a th:href="@{/ad/{id}(id=${ad.id})}"
                           class="font-medium text-blue-600 hover:underline"
                           th:text="${ad.title}">
                        </a>
                    </td>

                    <td class="p-3 text-right font-semibold"
                        th:text="|${#numbers.formatDecimal(ad.price,0,'NONE',2,'POINT')} CHF|">
                    </td>

                    <td class="p-3 hidden sm:table-cell" th:text="${ad.category}"></td>

                    <td class="p-3 hidden md:table-cell text-gray-500"
                        th:text="${#temporals.format(ad.createdAt, 'dd/MM/yyyy')}">
                    </td>

                    <td class="p-3 text-center">
                        <div class="flex flex-col sm:flex-row gap-2 justify-center">
                            <a th:href="@{/ad/edit/{id}(id=${ad.id})}"
                               class="px-3 py-1 text-xs rounded-lg bg-yellow-100 text-yellow-700 hover:bg-yellow-200"
                               th:text="#{profile.table.edit}">
                            </a>
                            <button type="button"
                                    class="px-3 py-1 text-xs rounded-lg bg-red-100 text-red-700 hover:bg-red-200"
                                    th:attr="data-delete-ad-id=${ad.id}"
                                    th:text="#{profile.table.delete}">
                            </button>
                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(ads)}">
                    <td colspan="5" class="text-center py-6 text-gray-400"
                        th:text="#{profile.table.empty}">
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <!-- PAGINATION -->
        <div class="flex justify-center items-center gap-2 p-4"
             th:if="${page != null and page.totalPages > 1}">

            <!-- Précédent -->
            <a th:if="${page.page > 0}"
               data-ajax="1"
               th:href="@{/profile(
            page=${page.page - 1},
            size=${param.size != null ? param.size[0] : 10},
            title=${param.title},
            category=${param.category},
            minPrice=${param.minPrice},
            maxPrice=${param.maxPrice},
            fromDate=${param.fromDate},
            toDate=${param.toDate}
       )}"
               class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300"
               th:title="#{pagination.previous}">
                ‹
            </a>

            <!-- Pages -->
            <a th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}"
               data-ajax="1"
               th:href="@{/profile(
            page=${i},
            size=${param.size != null ? param.size[0] : 10},
            title=${param.title},
            category=${param.category},
            minPrice=${param.minPrice},
            maxPrice=${param.maxPrice},
            fromDate=${param.fromDate},
            toDate=${param.toDate}
       )}"
               th:text="${i + 1}"
               th:classappend="${i == page.page}
            ? 'bg-blue-600 text-white'
            : 'bg-gray-100 hover:bg-gray-200'"
               class="px-3 py-1 rounded-lg text-sm"
               th:title="|#{pagination.page} ${i + 1}|">
            </a>

            <!-- Suivant -->
            <a th:if="${page.page < page.totalPages - 1}"
               data-ajax="1"
               th:href="@{/profile(
            page=${page.page + 1},
            size=${param.size != null ? param.size[0] : 10},
            title=${param.title},
            category=${param.category},
            minPrice=${param.minPrice},
            maxPrice=${param.maxPrice},
            fromDate=${param.fromDate},
            toDate=${param.toDate}
       )}"
               class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300"
               th:title="#{pagination.next}">
                ›
            </a>

        </div>

    </div>
</div>

<script th:inline="javascript">
    const MSG_CONFIRM_DELETE = /*[[#{profile.js.confirmDelete}]]*/ '';
    const MSG_DELETE_ERROR = /*[[#{profile.js.deleteError}]]*/ '';

    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-delete-ad-id]');
        if (!btn) return;

        if (!confirm(MSG_CONFIRM_DELETE)) return;

        const adId = btn.dataset.deleteAdId;
        const row = btn.closest('tr');

        try {
            const res = await fetch(`/ad/delete/${adId}`, {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            });
            if (!(res.ok || res.status === 302)) throw new Error();
            if (row) row.remove();
        } catch {
            alert(MSG_DELETE_ERROR);
        }
    });
</script>

</body>
</html>
